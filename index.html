<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboQuest: 3D Arm Simulator</title>
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #ff00ff;
            --bg: #0b0d17;
            --panel: rgba(20, 25, 40, 0.85);
            --text: #e0e6ed;
            --font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: var(--font); }
        canvas { display: block; outline: none; }

        /* UI Overlay */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* Header */
        header { padding: 15px; background: linear-gradient(90deg, rgba(0,0,0,0.8), transparent); display: flex; justify-content: space-between; align-items: center; pointer-events: auto; border-bottom: 1px solid var(--primary); }
        h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; color: var(--primary); text-shadow: 0 0 10px var(--primary); }
    [[1](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQGo6Fybs1mHVuIAoIArGLwjj28KfGChBGcvlGvRadv1uzKbK98E8e2Ek8GjcwTeW1pbHsP3q8DyOMkKZPmOuxb1RMPChM3agZiLLwUNBTnDEdNd1ZO1ZgLD3qgB0tI4W_7mPI8vn1Tzlk0%3D)] so the robot can easily reach the floor to grab the cube.

Save this code as `index.html` and open it.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboQuest: 3D Arm Simulator</title>
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #ff00ff;
            --bg: #0b0d17;
            --panel: rgba(20, 25, 40, 0.85);
            --text: #e0e6ed;
            --font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: var(--font); }
        canvas { display: block; outline: none; }

        /* UI Overlay */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* Header */
        header { padding: 15px; background: linear-gradient(90deg, rgba(0,0,0,0.8), transparent); display: flex; justify-content: space-between; align-items: center; pointer-events: auto; border-bottom: 1px solid var(--primary); }
        h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; color: var(--primary); text-shadow: 0 0 10px var(--primary); }
    [[1](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQEsPAjsKQcxMVN_sHp5rSgdRrLVd6sw6USD6dhIO6WUHNGtrdgM3CrtJZQFKbT2zXLyy0xo5JGP6RIQN7YcaTPYVBnoiG4_SKDSUssBy8MOv8DaPXeg-5WQuU7bMjOBQPf641zP1zA%3D)][[2](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQGVReH3ZYE44y09ati3LsmR1oRO9gvT5SY7K0kATLOp1BNvJb1hB1LBMUGfoC7ZXXQPEajctG7phPiIqAH7Xc5TJHoXd5DA5vpd2R1NeBc8JdoapOPUwQJsk168l2XEt--KQS_vrZvPZR5D3gZ1Kmp98Nk7xaK82KkCmjqLb_yYwHF5N3_5pYdb7a0lalEwPbDl40y2mlkczgAIuzOJ86lVpDOaCxvO)] so the robot can easily reach the floor to grab the cube.

Save this code as `index.html` a[[3](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQH8SiHAPLiFbbWpLv29Zh8ePoQFN4Gy-63ygRAaPskhl8-u-qUD5kx07atfRug1UhsjjfTErlfScg51YCzPIAViP7zEV3VOEOglCntuZJmzkxk5N5EnASVRPRGqrEuoGqbUDKfiz7E%3D)]nd open it.

```html[[2](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQGVReH3ZYE44y09ati3LsmR1oRO9gvT5SY7K0kATLOp1BNvJb1hB1LBMUGfoC7ZXXQPEajctG7phPiIqAH7Xc5TJHoXd5DA5vpd2R1NeBc8JdoapOPUwQJsk168l2XEt--KQS_vrZvPZR5D3gZ1Kmp98Nk7xaK82KkCmjqLb_yYwHF5N3_5pYdb7a0lalEwPbDl40y2mlkczgAIuzOJ86lVpDOaCxvO)][[3](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQH8SiHAPLiFbbWpLv29Zh8ePoQFN4Gy-63ygRAaPskhl8-u-qUD5kx07atfRug1UhsjjfTErlfScg51YCzPIAViP7zEV3VOEOglCntuZJmzkxk5N5EnASVRPRGqrEuoGqbUDKfiz7E%3D)]
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboQuest: 3D Arm Simulator</title>
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #ff00ff;
            --bg: #0b0d17;
            --panel: rgba(20, 25, 40, 0.85);
            --text: #e0e6ed;
            --font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: var(--font); }
        canvas { display: block; outline: none; }

        /* UI Overlay */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* Header */
        header { padding: 15px; background: linear-gradient(90deg, rgba(0,0,0,0.8), transparent); display: flex; justify-content: space-between; align-items: center; pointer-events: auto; border-bottom: 1px solid var(--primary); }
        h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        
        .stats { display: flex; gap: 20px; font-weight: bold; }
        .stat-box { background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; border: 1px solid var(--secondary); color: var(--secondary); }

        /* Sidebar Controls */
        aside { pointer-events: auto; width: 300px; background: var(--panel); backdrop-filter: blur(10px); height: 100%; border-right: 1px solid rgba(255,255,255,0.1); overflow-y: auto; display: flex; flex-direction: column; transition: transform 0.3s; }
        
        .panel-section { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        h3 { margin-top: 0; color: var(--primary); font-size: 0.9rem; text-transform: uppercase; }
        
        /* Sliders */
        .control-group { margin-bottom: 10px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 5px; display: flex; justify-content: space-between; }
        input[type=range] { width: 100%; accent-color: var(--primary); cursor: pointer; }

        /* Block Coding */
        #block-area { display: flex; flex-direction: column; gap: 5px; min-height: 100px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .code-block { background: #2d3748; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; border-left: 3px solid var(--secondary); transition: background 0.2s; }
        .code-block:hover { background: #4a5568; }
        .block-palette { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .btn { background: var(--primary); border: none; padding: 8px; color: #000; font-weight: bold; cursor: pointer; border-radius: 4px; text-transform: uppercase; font-size: 0.8rem; transition: 0.2s; }
        .btn:hover { filter: brightness(1.2); }
        .btn.secondary { background: var(--secondary); color: white; }
        .btn.danger { background: #ff4444; color: white; }

        /* Tutorial / Modal */
        #modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; background: var(--panel); border: 2px solid var(--primary); padding: 20px; border-radius: 10px; pointer-events: auto; box-shadow: 0 0 50px rgba(0,0,0,0.8); display: none; z-index: 100; }
        #modal.active { display: block; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: translate(-50%, -60%) scale(0.9); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        /* Notification */
        #notification { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 10px 20px; border-radius: 20px; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.5s; box-shadow: 0 0 20px var(--primary); }

        /* Responsive layout for mobile */
        @media (max-width: 768px) {
            aside { position: absolute; top: 50px; bottom: 0; transform: translateX(-100%); z-index: 10; }
            aside.open { transform: translateX(0); }
            #mobile-toggle { display: block !important; }
        }
        #mobile-toggle { display: none; position: absolute; top: 15px; left: 15px; z-index: 20; background: var(--panel); border: 1px solid var(--primary); color: white; padding: 5px 10px; }

        /* Sensor Overlay */
        .sensor-readout { position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); color: #0f0; font-family: 'Courier New', monospace; padding: 10px; border: 1px solid #0f0; pointer-events: none; font-size: 12px; }
        
        /* Help Text for Keys */
        .key-help { font-size: 0.7rem; color: #aaa; margin-top: 5px; display:flex; flex-wrap:wrap; gap:10px;}
        .key-badge { border: 1px solid #555; padding: 2px 4px; border-radius: 3px; background: #222; color: white; font-weight: bold;}
    </style>
    <!-- Import Three.js and OrbitControls as ES Modules -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- 3D Container -->
    <div id="canvas-container"></div>

    <!-- UI Overlay -->
    <div id="ui-layer">
        <header>
            <button id="mobile-toggle">☰ MENU</button>
            <h1>RoboQuest <span style="font-size:0.8rem; opacity:0.7;">SIMULATOR</span></h1>
            <div class="stats">
                <div class="stat-box">LEVEL: <span id="level-disp">1</span></div>
                <div class="stat-box">SCORE: <span id="score-disp">0</span></div>
            </div>
        </header>

        <!-- Sensor View -->
        <div class="sensor-readout">
            SENSOR FEED<br>
            > DIST: <span id="sensor-dist">--</span><br>
            > STATE: <span id="sensor-state">IDLE</span><br>
            > GRIP: <span id="sensor-grip">OPEN</span>
        </div>
    </div>

    <aside id="sidebar">
        <div class="panel-section">
            <h3>Mode Select</h3>
            <div style="display:flex; gap:5px;">
                <button class="btn" onclick="setMode('manual')">Manual</button>
                <button class="btn secondary" onclick="setMode('code')">Coder</button>
            </div>
        </div>

        <div id="manual-controls" class="panel-section">
            <h3>Manual Control (DOF)</h3>
            <div class="key-help">
                <div><span class="key-badge">A</span><span class="key-badge">D</span> Base</div>
                <div><span class="key-badge">W</span><span class="key-badge">S</span> Shoulder</div>
                <div><span class="key-badge">↑</span><span class="key-badge">↓</span> Elbow</div>
                <div><span class="key-badge">←</span><span class="key-badge">→</span> Wrist</div>
                <div><span class="key-badge">Q</span><span class="key-badge">E</span> Roll</div>
                <div><span class="key-badge">SPACE</span> Grab</div>
            </div>
            <hr style="border-color:#333; opacity:0.3;">
            
            <div class="control-group">
                <label>Base Rotation (J1) <span id="val-base">0°</span></label>
                <input type="range" min="-180" max="180" value="0" id="slider-base">
            </div>
            <div class="control-group">
                <label>Shoulder (J2) <span id="val-shoulder">0°</span></label>
                <input type="range" min="-90" max="90" value="0" id="slider-shoulder">
            </div>
            <div class="control-group">
                <label>Elbow (J3) <span id="val-elbow">0°</span></label>
                <!-- Expanded range to allow better reach -->
                <input type="range" min="-140" max="140" value="0" id="slider-elbow">
            </div>
            <div class="control-group">
                <label>Wrist Pitch (J4) <span id="val-wrist">0°</span></label>
                <!-- Expanded range for better tilt -->
                <input type="range" min="-110" max="110" value="0" id="slider-wrist">
            </div>
            <div class="control-group">
                <label>Wrist Roll (J5) <span id="val-roll">0°</span></label>
                <input type="range" min="-180" max="180" value="0" id="slider-roll">
            </div>
            <button class="btn secondary" style="width:100%" id="btn-grip-toggle">Toggle Gripper (Space)</button>
        </div>

        <div id="code-controls" class="panel-section" style="display:none;">
            <h3>Block Programming</h3>
            <div id="block-area">
                <em style="color:#888; text-align:center;">Drag blocks or Click to Add</em>
            </div>
            <div class="block-palette">
                <button class="btn" onclick="addBlock('base_left')">Base Left</button>
                <button class="btn" onclick="addBlock('base_right')">Base Right</button>
                <button class="btn" onclick="addBlock('lower')">Lower Arm</button>
                <button class="btn" onclick="addBlock('raise')">Raise Arm</button>
                <button class="btn secondary" onclick="addBlock('grip')">Grab/Drop</button>
            </div>
            <div style="margin-top:10px; display:flex; gap:5px;">
                <button class="btn" style="flex:1; background:#0f0;" onclick="runCode()">RUN PROGRAM</button>
                <button class="btn danger" onclick="clearCode()">CLEAR</button>
            </div>
        </div>

        <div class="panel-section">
            <h3>Customization</h3>
            <label>Skin Theme</label>
            <select id="skin-select" style="width:100%; padding:5px; background:#222; color:white; border:1px solid #555;">
                <option value="sci-fi">Neon Sci-Fi</option>
                <option value="industrial">Industrial Orange</option>
                <option value="stealth">Stealth Black</option>
            </select>
        </div>

        <div class="panel-section">
            <h3>Help & Info</h3>
            <button class="btn" onclick="showTutorial()">Show Tutorial</button>
            <div style="font-size:0.7rem; margin-top:10px; color:#aaa;">
                Mouse: Left Click to Drag Camera, Scroll to Zoom.
            </div>
        </div>
    </aside>

    <div id="notification">Level Complete!</div>

    <!-- Modal -->
    <div id="modal">
        <h2 id="modal-title" style="color:var(--primary); margin-top:0;">Welcome, Engineer!</h2>
        <p id="modal-body" style="line-height:1.5; color:#ddd;">
            Welcome to the robo-workshop. Your goal is to master the 5-Degree-of-Freedom (5DOF) robotic arm.
            <br><br>
            <strong>Controls:</strong><br>
            WASD = Base & Shoulder<br>
            Arrows = Elbow & Wrist<br>
            Space = Grab
            <br><br>
            <strong>Challenge 1:</strong> Pick up the Glowing Cube and place it in the Red Bin.
        </p>
        <button class="btn" style="width:100%" onclick="closeModal()">START SIMULATION</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- GLOBAL VARIABLES ---
        let scene, camera, renderer, controls;
        let robot = {};
        let targets = [], obstacles = [];
        let gripperOpen = true;
        let heldObject = null;
        let score = 0;
        let level = 1;
        let isExecutingCode = false;
        let executionQueue = [];
        let isMobileMenuOpen = false;

        // Audio Context
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        // DOM Elements
        const dom = {
            sliders: {
                base: document.getElementById('slider-base'),
                shoulder: document.getElementById('slider-shoulder'),
                elbow: document.getElementById('slider-elbow'),
                wrist: document.getElementById('slider-wrist'),
                roll: document.getElementById('slider-roll')
            },
            vals: {
                base: document.getElementById('val-base'),
                shoulder: document.getElementById('val-shoulder'),
                elbow: document.getElementById('val-elbow'),
                wrist: document.getElementById('val-wrist'),
                roll: document.getElementById('val-roll')
            },
            sensor: {
                dist: document.getElementById('sensor-dist'),
                state: document.getElementById('sensor-state'),
                grip: document.getElementById('sensor-grip')
            }
        };

        // --- INITIALIZATION ---
        init();
        animate();

        function init() {
            // Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0b0d17);
            scene.fog = new THREE.FogExp2(0x0b0d17, 0.02);

            // Camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI / 2 - 0.1; // Don't go below floor

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            scene.add(dirLight);

            const pointLight = new THREE.PointLight(0x00ffcc, 1, 10);
            pointLight.position.set(0, 2, 0);
            scene.add(pointLight);

            // Environment
            createEnvironment();
            
            // Robot
            createRobot();

            // Level Setup
            setupLevel(1);

            // Events
            window.addEventListener('resize', onWindowResize);
            setupUIListeners();
            
            // Show Welcome
            setTimeout(() => document.getElementById('modal').classList.add('active'), 500);
        }

        // --- ROBOT CONSTRUCTION ---
        function createRobot() {
            // Materials
            const matBody = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.4, metalness: 0.8 });
            const matJoint = new THREE.MeshStandardMaterial({ color: 0x00ffcc, emissive: 0x002211 });

            robot.root = new THREE.Group();
            scene.add(robot.root);

            // 1. Base (Static)
            const baseGeo = new THREE.CylinderGeometry(1, 1.2, 0.5, 16);
            const baseMesh = new THREE.Mesh(baseGeo, matBody);
            baseMesh.position.y = 0.25;
            baseMesh.castShadow = true;
            robot.root.add(baseMesh);

            // 2. Turret (J1 - Y Axis)
            robot.turret = new THREE.Group();
            robot.turret.position.y = 0.5;
            robot.root.add(robot.turret);

            const turretMesh = new THREE.Mesh(new THREE.BoxGeometry(1, 0.5, 1), matBody);
            turretMesh.position.y = 0.25;
            robot.turret.add(turretMesh);

            // 3. Shoulder (J2 - Z Axis)
            robot.shoulder = new THREE.Group();
            robot.shoulder.position.y = 0.5;
            robot.turret.add(robot.shoulder);

            const joint1 = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 1.2, 16), matJoint);
            joint1.rotation.x = Math.PI / 2;
            robot.shoulder.add(joint1);

            // Upper Arm
            robot.upperArm = new THREE.Group();
            robot.shoulder.add(robot.upperArm);
            
            const arm1Mesh = new THREE.Mesh(new THREE.BoxGeometry(0.4, 2, 0.4), matBody);
            arm1Mesh.position.y = 1;
            robot.upperArm.add(arm1Mesh);

            // 4. Elbow (J3 - Z Axis)
            robot.elbow = new THREE.Group();
            robot.elbow.position.y = 2;
            robot.upperArm.add(robot.elbow);

            const joint2 = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 1.1, 16), matJoint);
            joint2.rotation.x = Math.PI / 2;
            robot.elbow.add(joint2);

            // Forearm
            robot.forearm = new THREE.Group();
            robot.elbow.add(robot.forearm);

            const arm2Mesh = new THREE.Mesh(new THREE.BoxGeometry(0.3, 1.5, 0.3), matBody);
            arm2Mesh.position.y = 0.75;
            robot.forearm.add(arm2Mesh);

            // 5. Wrist Pitch (J4 - Z Axis)
            robot.wrist = new THREE.Group();
            robot.wrist.position.y = 1.5;
            robot.forearm.add(robot.wrist);

            const joint3 = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.8, 16), matJoint);
            joint3.rotation.x = Math.PI / 2;
            robot.wrist.add(joint3);

            // 6. Wrist Roll (J5 - Y Axis) & Hand
            robot.handRotator = new THREE.Group();
            robot.wrist.add(robot.handRotator);

            const handBase = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.2, 0.5), matBody);
            handBase.position.y = 0.1;
            robot.handRotator.add(handBase);

            // Grippers
            robot.leftFinger = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.4, 0.1), new THREE.MeshStandardMaterial({color:0x888888}));
            robot.leftFinger.position.set(-0.15, 0.4, 0);
            robot.handRotator.add(robot.leftFinger);

            robot.rightFinger = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.4, 0.1), new THREE.MeshStandardMaterial({color:0x888888}));
            robot.rightFinger.position.set(0.15, 0.4, 0);
            robot.handRotator.add(robot.rightFinger);

            // Define Gripper Center Point for physics
            robot.gripPoint = new THREE.Object3D();
            robot.gripPoint.position.set(0, 0.5, 0);
            robot.handRotator.add(robot.gripPoint);
        }

        function createEnvironment() {
            // Grid Floor
            const gridHelper = new THREE.GridHelper(20, 20, 0x333333, 0x111111);
            scene.add(gridHelper);

            // Floor Plane
            const planeGeo = new THREE.PlaneGeometry(20, 20);
            const planeMat = new THREE.MeshBasicMaterial({ color: 0x0b0d17 });
            const plane = new THREE.Mesh(planeGeo, planeMat);
            plane.rotation.x = -Math.PI / 2;
            plane.position.y = -0.01;
            scene.add(plane);
        }

        // --- LOGIC & PHYSICS ---
        function updatePhysics() {
            // 1. Read Slider/Variable Values
            const degToRad = Math.PI / 180;
            
            // Smooth interpolation (simple LERP)
            const lerp = (start, end, amt) => (1 - amt) * start + amt * end;
            const speed = 0.1;

            // Apply rotations from sliders
            robot.turret.rotation.y = lerp(robot.turret.rotation.y, -parseFloat(dom.sliders.base.value) * degToRad, speed);
            robot.shoulder.rotation.z = lerp(robot.shoulder.rotation.z, -parseFloat(dom.sliders.shoulder.value) * degToRad, speed);
            robot.elbow.rotation.z = lerp(robot.elbow.rotation.z, parseFloat(dom.sliders.elbow.value) * degToRad, speed);
            robot.wrist.rotation.z = lerp(robot.wrist.rotation.z, parseFloat(dom.sliders.wrist.value) * degToRad, speed);
            robot.handRotator.rotation.y = lerp(robot.handRotator.rotation.y, parseFloat(dom.sliders.roll.value) * degToRad, speed);

            // Gripper Animation
            const targetFingerX = gripperOpen ? 0.15 : 0.06;
            robot.leftFinger.position.x = lerp(robot.leftFinger.position.x, -targetFingerX, 0.2);
            robot.rightFinger.position.x = lerp(robot.rightFinger.position.x, targetFingerX, 0.2);

            // Update Displays
            dom.vals.base.innerText = dom.sliders.base.value + "°";
            dom.vals.shoulder.innerText = dom.sliders.shoulder.value + "°";
            dom.vals.elbow.innerText = dom.sliders.elbow.value + "°";
            dom.vals.wrist.innerText = dom.sliders.wrist.value + "°";
            dom.vals.roll.innerText = dom.sliders.roll.value + "°";
            
            // Collision/Grip Logic
            checkGrip();
            
            // Sensors
            updateSensors();
        }

        function updateSensors() {
            // Simple distance check to closest target
            const worldPos = new THREE.Vector3();
            robot.gripPoint.getWorldPosition(worldPos);

            let minD = Infinity;
            targets.forEach(t => {
                const d = worldPos.distanceTo(t.position);
                if(d < minD) minD = d;
            });

            dom.sensor.dist.innerText = minD < 10 ? minD.toFixed(2) + "m" : "NO TARGET";
            dom.sensor.grip.innerText = gripperOpen ? "OPEN" : "CLOSED";
            dom.sensor.state.innerText = heldObject ? "HOLDING" : "IDLE";
        }

        function checkGrip() {
            const worldPos = new THREE.Vector3();
            robot.gripPoint.getWorldPosition(worldPos);

            if (!gripperOpen && !heldObject) {
                // Try to grab
                for (let obj of targets) {
                    if (worldPos.distanceTo(obj.position) < 0.6) {
                        // GRAB!
                        heldObject = obj;
                        // Parenting logic for Three.js: attach object to gripper without jumping
                        robot.handRotator.attach(heldObject); 
                        playSound('grab');
                        dom.sensor.state.style.color = "#00ffcc";
                        break;
                    }
                }
            } else if (gripperOpen && heldObject) {
                // DROP!
                scene.attach(heldObject); // Attach back to world
                
                // Check if dropped in bin
                const dropPos = heldObject.position;
                if (dropPos.x > 2 && dropPos.x < 4 && dropPos.z > -1 && dropPos.z < 1) {
                    levelComplete();
                } else {
                    // Physics "fall" (simple)
                    heldObject.position.y = 0.25; 
                }
                heldObject = null;
                dom.sensor.state.style.color = "#0f0";
            }
        }

        function toggleGripper() {
            gripperOpen = !gripperOpen;
        }

        // --- GAMEPLAY ---
        function setupLevel(lvl) {
            level = lvl;
            document.getElementById('level-disp').innerText = level;
            
            // Clear old objects
            targets.forEach(t => scene.remove(t));
            targets = [];
            obstacles.forEach(o => scene.remove(o));
            obstacles = [];

            // Reset Arm
            dom.sliders.base.value = 0;
            dom.sliders.shoulder.value = 0;
            dom.sliders.elbow.value = 0;
            dom.sliders.wrist.value = 0;
            dom.sliders.roll.value = 0;

            gripperOpen = true;
            if(heldObject) { scene.attach(heldObject); heldObject = null; }

            // Create Target (Glowing Cube)
            const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            const material = new THREE.MeshStandardMaterial({ color: 0xff00ff, emissive: 0x550055 });
            const cube = new THREE.Mesh(geometry, material);
            
            // Level Logic
            if (lvl === 1) {
                cube.position.set(2, 0.25, 0);
            } else if (lvl === 2) {
                cube.position.set(-2, 0.25, 2);
                // Add obstacle
                const obs = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color:0xff0000}));
                obs.position.set(-1, 1, 1);
                scene.add(obs);
                obstacles.push(obs);
            } else {
                // Random
                cube.position.set((Math.random()*4)-2, 0.25, (Math.random()*4)-2);
            }
            
            cube.castShadow = true;
            scene.add(cube);
            targets.push(cube);

            // Create Bin
            if (!scene.getObjectByName('bin')) {
                const binGeo = new THREE.BoxGeometry(2, 0.1, 2);
                const binMat = new THREE.MeshStandardMaterial({ color: 0xff0000, transparent: true, opacity: 0.5 });
                const bin = new THREE.Mesh(binGeo, binMat);
                bin.position.set(3, 0.05, 0);
                bin.name = 'bin';
                scene.add(bin);
                
                // Bin visual marker
                const marker = new THREE.Mesh(new THREE.RingGeometry(0.8, 1, 32), new THREE.MeshBasicMaterial({color:0xff0000, side:THREE.DoubleSide}));
                marker.rotation.x = -Math.PI/2;
                marker.position.y = 0.1;
                bin.add(marker);
            }
        }

        function levelComplete() {
            score += 100;
            document.getElementById('score-disp').innerText = score;
            playSound('success');
            createConfetti();
            showNotification("Level " + level + " Complete!");
            
            setTimeout(() => {
                setupLevel(level + 1);
            }, 3000);
        }

        function createConfetti() {
            const geometry = new THREE.BufferGeometry();
            const count = 500;
            const positions = [];
            const colors = [];
            
            for(let i=0; i<count; i++) {
                positions.push(3, 2, 0); // Start at bin
                colors.push(Math.random(), Math.random(), Math.random());
            }
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const material = new THREE.PointsMaterial({ size: 0.1, vertexColors: true });
            const particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // Animate particles
            const velocities = [];
            for(let i=0; i<count; i++) velocities.push({
                x: (Math.random()-0.5)*0.2,
                y: (Math.random())*0.2,
                z: (Math.random()-0.5)*0.2
            });

            let frame = 0;
            function tick() {
                const pos = particles.geometry.attributes.position.array;
                for(let i=0; i<count; i++) {
                    pos[i*3] += velocities[i].x;
                    pos[i*3+1] += velocities[i].y;
                    pos[i*3+2] += velocities[i].z;
                    velocities[i].y -= 0.005; // Gravity
                }
                particles.geometry.attributes.position.needsUpdate = true;
                frame++;
                if(frame < 100) requestAnimationFrame(tick);
                else scene.remove(particles);
            }
            tick();
        }

        // --- UI & PROGRAMMING ---
        window.setMode = (mode) => {
            document.getElementById('manual-controls').style.display = mode === 'manual' ? 'block' : 'none';
            document.getElementById('code-controls').style.display = mode === 'code' ? 'block' : 'none';
        };

        window.addBlock = (type) => {
            const area = document.getElementById('block-area');
            const el = document.createElement('div');
            el.className = 'code-block';
            el.innerText = type.replace('_', ' ').toUpperCase();
            el.dataset.type = type;
            el.onclick = () => el.remove(); // Click to delete
            area.appendChild(el);
        };

        window.clearCode = () => {
            document.getElementById('block-area').innerHTML = '<em style="color:#888; text-align:center;">Drag blocks or Click to Add</em>';
        };

        window.runCode = () => {
            if(isExecutingCode) return;
            const blocks = document.querySelectorAll('#block-area .code-block');
            if(blocks.length === 0) return;

            isExecutingCode = true;
            let index = 0;

            function executeStep() {
                if (index >= blocks.length) {
                    isExecutingCode = false;
                    return;
                }

                const type = blocks[index].dataset.type;
                // highlight current block
                blocks.forEach(b => b.style.borderLeft = "3px solid var(--secondary)");
                blocks[index].style.borderLeft = "3px solid white";

                // Action Logic
                const stepSize = 20;
                
                if(type === 'base_left') updateSlider('slider-base', 20);
                if(type === 'base_right') updateSlider('slider-base', -20);
                if(type === 'lower') updateSlider('slider-shoulder', 20);
                if(type === 'raise') updateSlider('slider-shoulder
